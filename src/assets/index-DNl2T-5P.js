var e=Object.defineProperty,t=(t,s,a)=>((t,s,a)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a)(t,"symbol"!=typeof s?s+"":s,a);import{_ as s,u as a,e as l,a as i,X as n,N as o,M as r,p as c,k as u}from"./index-DrVrvTnw.js";import{g as m,b,a as v,c as d}from"./index--XRi0qPk.js";import{c as p}from"./public-CZgsCybE.js";import{a as y,c as h,r as f,f as g,n as k,b as C,X as _,k as w,u as L,Y as D,F as E,aa as T,a4 as j,az as R,W as S,y as B,ay as I}from"./vue-vendor-kmzIwNuM.js";import{d as q}from"./lodash-es-Bns1-fiI.js";import"./ui-vendor-B3b54x8g.js";class F{constructor(e){t(this,"self",null),t(this,"subscribers",{}),t(this,"requestsPending",!1),t(this,"barList",[]),this.self=e}onReady(e){this.self.getConfig(e)}async getBars(e,t,s,a,l,i,n){if(this.requestsPending)return;n&&(this.barList=[],s=""),this.requestsPending=!0;const o=await this.self.getBars({symbolInfo:e,resolution:t,from:s,to:a,onHistoryCallback:l,onErrorCallback:i,firstDataRequest:n});this.requestsPending=!1,o&&o.length?(this.barList=o.concat(this.barList),this.barList.length?l(this.barList,{noData:!1,nextTime:this.barList[0].time}):l([],{noData:!0})):l([],{noData:!0})}subscribeBars(e,t,s,a,l){this.subscribers[a]||(this.subscribers[a]={lastBarTime:null,resolution:t,onRealtimeCallback:s,onResetCacheNeededCallback:l})}unsubscribeBars(e){this.subscribers[e]&&delete this.subscribers[e]}async resolveSymbol(e,t,s){return t(await this.self.resolveSymbol())}updateData(e){let t=Object.keys(this.subscribers)[0]||"",s=this.subscribers[t]||{};if(s.lastBarTime<e.time)this.barList.push(e),s.lastBarTime=e.time,(null==s?void 0:s.onRealtimeCallback)&&(null==s||s.onRealtimeCallback(e));else if(s.lastBarTime==e.time){let t=this.barList.slice(-1);Object.keys(t).forEach(s=>{t[s]=e[s]}),(null==s?void 0:s.onRealtimeCallback)&&(null==s||s.onRealtimeCallback(e))}}}const N={class:"tradeChart"},O={class:"intervalList"},U=["onClick"],A=["id"],x={class:"intervalList"},M=["onClick"],P={class:"btn"},K=s({__name:"index",props:{type:{type:String,default:"detail"}},setup(e){const t=R(),s=I(),{t:K}=a(),Y=e,z=y(JSON.parse(decodeURI(t.query.data))),H=h(()=>{let e=1e4;return(null==z?void 0:z.amount)>100?e=100:(null==z?void 0:z.amount)<.1?e=1e6:(null==z?void 0:z.amount)<100&&(e=1e4),e}),X={time:"",amount:"",open:"",high:"",low:"",close:"",volume:"",lastClose:"",intervention:!1},G=f(""),J=v(),V=d(),W=y([]);let $=[],Q=null,Z=y([]),ee=y({}),te=y({});const se=h(()=>`kline_${Y.type}`);let ae=null;const le=l(),ie=i(),ne=q(e=>{let t=e.detail.symbol,s=e.detail.coinInfo,a=re(s);a.map(e=>e.value).join()!=W.map(e=>e.value).join()&&($=oe(),W.splice(0,W.length,...a),Object.assign(te,W[0])),he.value=!1,ce(t,te.interval,()=>{Object.assign(ee,z)})},200),oe=(e=ee)=>{let t=J.map(e=>e.interval);return"mt5"==(null==e?void 0:e.market)&&(t=J.filter(e=>"mt5"==e.market).map(e=>e.interval)),t},re=(e=ee)=>{let t=J.filter(e=>!(null==e?void 0:e.isMore));return"mt5"!=(null==e?void 0:e.market)&&3!==(null==e?void 0:e.coinType)||(t=J.filter(e=>"mt5"==e.market)),t};g(async()=>{Object.assign(ee,z),$=oe(),W.splice(0,W.length,...re()),Object.assign(te,W[0]),document.addEventListener("event_tradeSymbolChange",ne),k(()=>{me()})}),C(()=>{document.removeEventListener("event_tradeSymbolChange",ne),de(!0),ae.remove()});const ce=async(e,t,s)=>{ee.symbol==e&&t==te.interval||null==ae||ae.setSymbol(e,t,()=>{Object.assign(te,J.find(e=>e.interval==t)),s&&s()})},ue={getConfig:async e=>{setTimeout(()=>{e({supported_resolutions:$,supports_marks:!1,supports_timescale_marks:!0,supports_time:!0})},0)},getServerTime:async e=>{e&&e(+new Date)},getBars:async({symbolInfo:e,resolution:t,from:s,firstDataRequest:a})=>{let l=J.find(e=>e.interval==t);try{if(l&&(""==s||s>0)){let t={symbol:e.coinUpperCase,interval:l.key,limit:1e3};s&&(t.end=s);const{data:i}=await m({...t,interval:l.key,symbol:e.coinUpperCase,market:e.market});let n=[];if(i&&(ie.setKlineTicker(i.ticker),n=i.historyKline),n=n.map(e=>({open:parseFloat(e.o),high:parseFloat(e.h),low:parseFloat(e.l),close:parseFloat(c(e.c)),amount:parseFloat(c(e.c)),volume:parseFloat(e.v),time:e.T})).sort((e,t)=>e.time-t.time),a){let t=n.slice(-1)[0];X.amount=t.amount,X.open=t.open,X.close=t.close,X.high=t.high,X.low=t.low,X.volume=t.volume,X.time=t.time,X.lastClose=t.close,X.intervention=!1,G.value=Math.abs(X.time-n.slice(-2,-1)[0].time),ye(X),pe({coin:e.coin,symbol:e.symbol,interval:l.key,firstDataRequest:a})}return n}}catch(i){return de(!0),[]}return[]},resolveSymbol:async()=>({name:null==z?void 0:z.symbolUpperCase,coin:null==z?void 0:z.coin,coinUpperCase:null==z?void 0:z.coin,symbol:null==z?void 0:z.symbol,symbolUpperCase:null==z?void 0:z.symbolUpperCase,market:z.market,fractional:!1,session:"24x7",has_intraday:!0,has_weekly_and_monthly:!0,exchange:__config._APP_EXCHANGE_NAME,description:z.symbolUpperCase,pricescale:H.value,minmov:1/H.value,supported_resolutions:$})},me=()=>{Q=new F(ue);let e=window.__theme;ae=new TradingView.widget({symbol:z.symbolUpperCase,theme:e,debug:!1,autosize:!0,interval:te.interval,container_id:se.value,datafeed:Q,library_path:"/charting_library/",custom_css_url:"dark"===window.__theme?"../tradingview.dark.css":"../tradingview.light.css",locale:"en",timezone:le.timezone,customFormatters:{dateFormatter:{format:e=>p(e.getTime(),"DD/MM/YYYY",!0)},timeFormatter:{format:e=>p(e.getTime(),"HH:mm:ss",!0)}},preset:"mobile",...b(e)}),ae.onChartReady(()=>{be()})},be=()=>{let e=ge(V[0].name);Z.push(e)},ve=[],de=(e=!1)=>{ee.coin&&(n.send({op:o.unsubscribe,type:o.KLINE,symbol:ee.coin,interval:te.key}),e&&(ve.forEach(e=>{e&&r.unsubscribe(e)}),ve.length=0,n.send({op:o.unsubscribe,type:o.TRADE,symbol:ee.coin})))},pe=async e=>{de(e.firstDataRequest),n.send({op:o.subscribe,type:o.KLINE,symbol:e.coin,interval:e.interval}),e.firstDataRequest&&n.send({op:o.subscribe,type:o.TRADE,symbol:e.coin});let t=r.subscribe(o.KLINE,(t,s)=>{let a=s.data.tick;if(s.symbol==e.coin){X.intervention!=(null==a?void 0:a.intervention)&&(a.open=X.lastClose,X.intervention=null==a?void 0:a.intervention);let e=parseInt(a.id/G.value)*G.value;X.time<e&&(X.time=e,X.open=a.open),X.high=a.high,X.low=a.low,X.close=Number(c(a.close)),X.volume=a.vol,ye(X)}});ve.push(t)},ye=e=>{(null==e?void 0:e.close)&&(Q.updateData(e),r.publish(o.DETAIL,{data:{...e,vol:e.volume},origin:"kline",symbol:ee.coin,type:o.DETAIL}))},he=f(!1),fe=f(""),ge=e=>{if(fe.value==e)return;const t=ae.activeChart();if(fe.value){V.filter(e=>e.name==fe.value)[0].list.forEach(e=>{t.removeEntity(e)})}fe.value=e;let s=V.filter(e=>e.name==fe.value)[0],a=[];s.cycleList.forEach(async(l,i)=>{let n="";n="MACD"==e||"Bollinger Bands"==e?await t.createStudy(fe.value,!1,!1,[],{}):await t.createStudy(fe.value,!1,!1,[l],{"plot.color":s.colorList[i],"plot.linewidth":2}),a.push(n)}),s.list=a};return(e,t)=>{const a=u;return S(),_(E,null,[w(a,{title:L(z).showSymbol},null,8,["title"]),D("div",N,[D("div",O,[(S(!0),_(E,null,T(L(W),(e,t)=>(S(),_("div",{onClick:t=>((e,t="")=>{e.interval!=te.interval&&ce(z.symbol,e.interval),he.value=!!t})(e),class:B([e.interval===L(te).interval&&"active"]),key:t},[D("span",null,j(e.value),1)],10,U))),128))]),D("div",{id:se.value,class:"candlestick"},null,8,A),D("div",x,[(S(!0),_(E,null,T(L(V),(e,t)=>(S(),_("div",{key:t,class:B(e.name===L(fe)?"active":""),onClick:t=>ge(e.name)},j(e.label),11,M))),128))]),D("div",P,[D("div",{class:"btn-item rose",onClick:t[0]||(t[0]=e=>L(s).back())},j(L(K)("buy1")),1),D("div",{class:"btn-item fall",onClick:t[1]||(t[1]=e=>L(s).back())},j(L(K)("sell1")),1)])])],64)}}},[["__scopeId","data-v-f4d87e53"]]);export{K as default};
